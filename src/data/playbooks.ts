// Response Playbooks Data

export type PlaybookStepStatus = 'pending' | 'in_progress' | 'completed' | 'skipped';

export interface PlaybookStep {
  id: string;
  order: number;
  title: string;
  description: string;
  actionType: 'manual' | 'automated' | 'decision';
  estimatedMinutes: number;
  required: boolean;
  automationHook?: string;
}

export interface Playbook {
  id: string;
  name: string;
  description: string;
  incidentType: string;
  severity: string[];
  mitreTechniques: string[];
  steps: PlaybookStep[];
  estimatedDuration: number;
  createdAt: Date;
  updatedAt: Date;
}

export interface PlaybookExecution {
  id: string;
  playbookId: string;
  incidentId: string;
  startedAt: Date;
  completedAt?: Date;
  currentStepId: string;
  stepStatuses: Record<string, { status: PlaybookStepStatus; completedAt?: Date; notes?: string }>;
  executedBy: string;
}

export const defaultPlaybooks: Playbook[] = [
  {
    id: 'pb-phishing',
    name: 'Phishing Response',
    description: 'Standard response procedure for suspected phishing attacks',
    incidentType: 'phishing',
    severity: ['critical', 'high', 'medium'],
    mitreTechniques: ['T1566', 'T1204', 'T1114'],
    estimatedDuration: 60,
    createdAt: new Date('2024-01-01'),
    updatedAt: new Date('2024-01-15'),
    steps: [
      {
        id: 'ph-1',
        order: 1,
        title: 'Identify Affected Users',
        description: 'Query email logs to identify all recipients of the phishing email. Check for any users who clicked links or opened attachments.',
        actionType: 'manual',
        estimatedMinutes: 10,
        required: true,
      },
      {
        id: 'ph-2',
        order: 2,
        title: 'Contain the Threat',
        description: 'Block the sender domain/IP at the email gateway. Quarantine the phishing email from all mailboxes.',
        actionType: 'automated',
        estimatedMinutes: 5,
        required: true,
        automationHook: 'email_quarantine',
      },
      {
        id: 'ph-3',
        order: 3,
        title: 'Reset Compromised Credentials',
        description: 'For users who entered credentials, immediately reset their passwords and revoke active sessions.',
        actionType: 'manual',
        estimatedMinutes: 15,
        required: true,
      },
      {
        id: 'ph-4',
        order: 4,
        title: 'Scan for Malware',
        description: 'Run full endpoint scans on systems where attachments were opened.',
        actionType: 'automated',
        estimatedMinutes: 20,
        required: true,
        automationHook: 'endpoint_scan',
      },
      {
        id: 'ph-5',
        order: 5,
        title: 'Notify Affected Users',
        description: 'Send notification to affected users about the phishing attempt and any actions they need to take.',
        actionType: 'manual',
        estimatedMinutes: 10,
        required: false,
      },
      {
        id: 'ph-6',
        order: 6,
        title: 'Document and Close',
        description: 'Document all findings, update threat intelligence, and close the incident.',
        actionType: 'manual',
        estimatedMinutes: 10,
        required: true,
      },
    ],
  },
  {
    id: 'pb-ransomware',
    name: 'Ransomware Response',
    description: 'Critical response procedure for ransomware infections',
    incidentType: 'ransomware',
    severity: ['critical'],
    mitreTechniques: ['T1486', 'T1489', 'T1059', 'T1070'],
    estimatedDuration: 240,
    createdAt: new Date('2024-01-01'),
    updatedAt: new Date('2024-01-20'),
    steps: [
      {
        id: 'rw-1',
        order: 1,
        title: 'Isolate Affected Systems',
        description: 'Immediately disconnect affected systems from the network to prevent spread. Do NOT power off systems.',
        actionType: 'manual',
        estimatedMinutes: 5,
        required: true,
      },
      {
        id: 'rw-2',
        order: 2,
        title: 'Identify Ransomware Variant',
        description: 'Analyze ransom note and encrypted file extensions to identify the ransomware family.',
        actionType: 'manual',
        estimatedMinutes: 15,
        required: true,
      },
      {
        id: 'rw-3',
        order: 3,
        title: 'Assess Scope of Infection',
        description: 'Determine all affected systems, file shares, and backup status.',
        actionType: 'manual',
        estimatedMinutes: 30,
        required: true,
      },
      {
        id: 'rw-4',
        order: 4,
        title: 'Preserve Evidence',
        description: 'Capture memory dumps and disk images from affected systems for forensic analysis.',
        actionType: 'manual',
        estimatedMinutes: 60,
        required: true,
      },
      {
        id: 'rw-5',
        order: 5,
        title: 'Check for Decryption Tools',
        description: 'Search NoMoreRansom.org and other resources for available decryption tools.',
        actionType: 'decision',
        estimatedMinutes: 10,
        required: true,
      },
      {
        id: 'rw-6',
        order: 6,
        title: 'Notify Leadership',
        description: 'Brief executive leadership and legal team. Determine if law enforcement notification is required.',
        actionType: 'manual',
        estimatedMinutes: 20,
        required: true,
      },
      {
        id: 'rw-7',
        order: 7,
        title: 'Begin Recovery',
        description: 'Rebuild systems from clean images and restore data from verified clean backups.',
        actionType: 'manual',
        estimatedMinutes: 120,
        required: true,
      },
      {
        id: 'rw-8',
        order: 8,
        title: 'Post-Incident Review',
        description: 'Conduct lessons learned session and update security controls.',
        actionType: 'manual',
        estimatedMinutes: 60,
        required: true,
      },
    ],
  },
  {
    id: 'pb-unauthorized-access',
    name: 'Unauthorized Access Response',
    description: 'Response procedure for detected unauthorized access attempts',
    incidentType: 'unauthorized_access',
    severity: ['critical', 'high', 'medium'],
    mitreTechniques: ['T1078', 'T1110', 'T1021', 'T1133'],
    estimatedDuration: 90,
    createdAt: new Date('2024-01-01'),
    updatedAt: new Date('2024-01-10'),
    steps: [
      {
        id: 'ua-1',
        order: 1,
        title: 'Verify the Alert',
        description: 'Confirm the unauthorized access is not a false positive by reviewing authentication logs.',
        actionType: 'manual',
        estimatedMinutes: 10,
        required: true,
      },
      {
        id: 'ua-2',
        order: 2,
        title: 'Disable Compromised Account',
        description: 'Immediately disable the compromised user account to prevent further access.',
        actionType: 'automated',
        estimatedMinutes: 2,
        required: true,
        automationHook: 'disable_account',
      },
      {
        id: 'ua-3',
        order: 3,
        title: 'Review Access History',
        description: 'Analyze all activities performed by the compromised account during the unauthorized session.',
        actionType: 'manual',
        estimatedMinutes: 20,
        required: true,
      },
      {
        id: 'ua-4',
        order: 4,
        title: 'Check for Lateral Movement',
        description: 'Review logs for signs of lateral movement to other systems or accounts.',
        actionType: 'manual',
        estimatedMinutes: 25,
        required: true,
      },
      {
        id: 'ua-5',
        order: 5,
        title: 'Block Attacker IPs',
        description: 'Add source IP addresses to firewall block lists.',
        actionType: 'automated',
        estimatedMinutes: 5,
        required: true,
        automationHook: 'block_ip',
      },
      {
        id: 'ua-6',
        order: 6,
        title: 'Reset Credentials',
        description: 'Reset passwords and revoke all active sessions for affected accounts.',
        actionType: 'manual',
        estimatedMinutes: 15,
        required: true,
      },
      {
        id: 'ua-7',
        order: 7,
        title: 'Document Findings',
        description: 'Document all findings and update incident report.',
        actionType: 'manual',
        estimatedMinutes: 15,
        required: true,
      },
    ],
  },
  {
    id: 'pb-data-breach',
    name: 'Data Breach Response',
    description: 'Comprehensive response for confirmed or suspected data breaches',
    incidentType: 'data_breach',
    severity: ['critical', 'high'],
    mitreTechniques: ['T1005', 'T1041', 'T1567', 'T1114'],
    estimatedDuration: 480,
    createdAt: new Date('2024-01-01'),
    updatedAt: new Date('2024-01-25'),
    steps: [
      {
        id: 'db-1',
        order: 1,
        title: 'Confirm Data Breach',
        description: 'Verify that sensitive data has been accessed or exfiltrated.',
        actionType: 'manual',
        estimatedMinutes: 30,
        required: true,
      },
      {
        id: 'db-2',
        order: 2,
        title: 'Contain the Breach',
        description: 'Isolate affected systems and revoke access to compromised data sources.',
        actionType: 'manual',
        estimatedMinutes: 20,
        required: true,
      },
      {
        id: 'db-3',
        order: 3,
        title: 'Identify Affected Data',
        description: 'Determine what types of data were accessed (PII, financial, health, etc.).',
        actionType: 'manual',
        estimatedMinutes: 60,
        required: true,
      },
      {
        id: 'db-4',
        order: 4,
        title: 'Assess Regulatory Requirements',
        description: 'Determine notification requirements based on data type and jurisdiction (GDPR, HIPAA, etc.).',
        actionType: 'decision',
        estimatedMinutes: 30,
        required: true,
      },
      {
        id: 'db-5',
        order: 5,
        title: 'Notify Legal and Compliance',
        description: 'Brief legal counsel and compliance team on breach details.',
        actionType: 'manual',
        estimatedMinutes: 30,
        required: true,
      },
      {
        id: 'db-6',
        order: 6,
        title: 'Preserve Evidence',
        description: 'Collect and preserve all relevant logs, system images, and artifacts.',
        actionType: 'manual',
        estimatedMinutes: 120,
        required: true,
      },
      {
        id: 'db-7',
        order: 7,
        title: 'Prepare Notifications',
        description: 'Draft notifications for affected individuals and regulatory bodies.',
        actionType: 'manual',
        estimatedMinutes: 60,
        required: true,
      },
      {
        id: 'db-8',
        order: 8,
        title: 'Implement Remediation',
        description: 'Address vulnerabilities that led to the breach.',
        actionType: 'manual',
        estimatedMinutes: 120,
        required: true,
      },
    ],
  },
  {
    id: 'pb-malware',
    name: 'Malware Response',
    description: 'Standard response for malware detection on endpoints',
    incidentType: 'malware',
    severity: ['critical', 'high', 'medium'],
    mitreTechniques: ['T1059', 'T1547', 'T1027', 'T1486'],
    estimatedDuration: 75,
    createdAt: new Date('2024-01-01'),
    updatedAt: new Date('2024-01-12'),
    steps: [
      {
        id: 'mw-1',
        order: 1,
        title: 'Isolate Affected Endpoint',
        description: 'Quarantine the infected system from the network.',
        actionType: 'automated',
        estimatedMinutes: 2,
        required: true,
        automationHook: 'isolate_endpoint',
      },
      {
        id: 'mw-2',
        order: 2,
        title: 'Identify Malware Type',
        description: 'Analyze the malware sample to determine its type and capabilities.',
        actionType: 'manual',
        estimatedMinutes: 20,
        required: true,
      },
      {
        id: 'mw-3',
        order: 3,
        title: 'Check for Spread',
        description: 'Search for indicators of compromise on other endpoints.',
        actionType: 'automated',
        estimatedMinutes: 15,
        required: true,
        automationHook: 'ioc_hunt',
      },
      {
        id: 'mw-4',
        order: 4,
        title: 'Remove Malware',
        description: 'Clean or reimage the affected system.',
        actionType: 'manual',
        estimatedMinutes: 25,
        required: true,
      },
      {
        id: 'mw-5',
        order: 5,
        title: 'Update Signatures',
        description: 'Add new IOCs to security tools and block related indicators.',
        actionType: 'automated',
        estimatedMinutes: 5,
        required: true,
        automationHook: 'update_signatures',
      },
      {
        id: 'mw-6',
        order: 6,
        title: 'Restore and Verify',
        description: 'Restore system to production and verify malware is fully removed.',
        actionType: 'manual',
        estimatedMinutes: 10,
        required: true,
      },
    ],
  },
  {
    id: 'pb-ddos',
    name: 'DDoS Attack Response',
    description: 'Response procedure for Distributed Denial of Service attacks',
    incidentType: 'ddos',
    severity: ['critical', 'high'],
    mitreTechniques: ['T1498', 'T1499'],
    estimatedDuration: 120,
    createdAt: new Date('2024-01-01'),
    updatedAt: new Date('2024-01-18'),
    steps: [
      {
        id: 'ddos-1',
        order: 1,
        title: 'Identify Attack Type',
        description: 'Determine if the attack is volumetric, protocol-based, or application layer.',
        actionType: 'manual',
        estimatedMinutes: 10,
        required: true,
      },
      {
        id: 'ddos-2',
        order: 2,
        title: 'Activate DDoS Mitigation',
        description: 'Enable DDoS protection services (Cloudflare, AWS Shield, etc.).',
        actionType: 'automated',
        estimatedMinutes: 5,
        required: true,
        automationHook: 'enable_ddos_protection',
      },
      {
        id: 'ddos-3',
        order: 3,
        title: 'Implement Rate Limiting',
        description: 'Apply rate limiting rules to affected endpoints.',
        actionType: 'manual',
        estimatedMinutes: 15,
        required: true,
      },
      {
        id: 'ddos-4',
        order: 4,
        title: 'Block Malicious IPs',
        description: 'Identify and block attacking IP ranges at the firewall level.',
        actionType: 'automated',
        estimatedMinutes: 10,
        required: true,
        automationHook: 'block_ip_range',
      },
      {
        id: 'ddos-5',
        order: 5,
        title: 'Scale Resources',
        description: 'Scale up infrastructure to handle increased load if needed.',
        actionType: 'decision',
        estimatedMinutes: 20,
        required: false,
      },
      {
        id: 'ddos-6',
        order: 6,
        title: 'Monitor and Adjust',
        description: 'Continuously monitor traffic and adjust mitigation rules.',
        actionType: 'manual',
        estimatedMinutes: 60,
        required: true,
      },
    ],
  },
  {
    id: 'pb-insider-threat',
    name: 'Insider Threat Response',
    description: 'Response procedure for suspected insider threat activities',
    incidentType: 'insider_threat',
    severity: ['critical', 'high', 'medium'],
    mitreTechniques: ['T1078', 'T1074', 'T1020', 'T1567'],
    estimatedDuration: 180,
    createdAt: new Date('2024-01-01'),
    updatedAt: new Date('2024-01-22'),
    steps: [
      {
        id: 'it-1',
        order: 1,
        title: 'Verify Suspicious Activity',
        description: 'Review DLP alerts, access logs, and behavior analytics to confirm insider threat indicators.',
        actionType: 'manual',
        estimatedMinutes: 30,
        required: true,
      },
      {
        id: 'it-2',
        order: 2,
        title: 'Notify HR and Legal',
        description: 'Brief HR and legal teams about the suspected insider threat before taking action.',
        actionType: 'manual',
        estimatedMinutes: 15,
        required: true,
      },
      {
        id: 'it-3',
        order: 3,
        title: 'Preserve Evidence',
        description: 'Capture logs, emails, and file access records for investigation.',
        actionType: 'manual',
        estimatedMinutes: 45,
        required: true,
      },
      {
        id: 'it-4',
        order: 4,
        title: 'Restrict Access',
        description: 'Limit or revoke access to sensitive systems and data without alerting the suspect.',
        actionType: 'manual',
        estimatedMinutes: 20,
        required: true,
      },
      {
        id: 'it-5',
        order: 5,
        title: 'Monitor Communications',
        description: 'Enable enhanced monitoring of the suspect communications (with legal approval).',
        actionType: 'decision',
        estimatedMinutes: 15,
        required: false,
      },
      {
        id: 'it-6',
        order: 6,
        title: 'Conduct Interview',
        description: 'Work with HR to interview the suspected insider if appropriate.',
        actionType: 'manual',
        estimatedMinutes: 60,
        required: false,
      },
    ],
  },
  {
    id: 'pb-supply-chain',
    name: 'Supply Chain Attack Response',
    description: 'Response procedure for supply chain compromise incidents',
    incidentType: 'supply_chain',
    severity: ['critical', 'high'],
    mitreTechniques: ['T1195', 'T1199', 'T1072'],
    estimatedDuration: 300,
    createdAt: new Date('2024-01-01'),
    updatedAt: new Date('2024-01-28'),
    steps: [
      {
        id: 'sc-1',
        order: 1,
        title: 'Identify Compromised Software',
        description: 'Determine which third-party software or dependency has been compromised.',
        actionType: 'manual',
        estimatedMinutes: 45,
        required: true,
      },
      {
        id: 'sc-2',
        order: 2,
        title: 'Inventory Affected Systems',
        description: 'Identify all systems running the compromised software version.',
        actionType: 'automated',
        estimatedMinutes: 30,
        required: true,
        automationHook: 'software_inventory',
      },
      {
        id: 'sc-3',
        order: 3,
        title: 'Isolate Affected Systems',
        description: 'Quarantine systems with the compromised software to prevent further spread.',
        actionType: 'manual',
        estimatedMinutes: 30,
        required: true,
      },
      {
        id: 'sc-4',
        order: 4,
        title: 'Analyze for Backdoors',
        description: 'Check for any backdoors or persistent access mechanisms installed.',
        actionType: 'manual',
        estimatedMinutes: 60,
        required: true,
      },
      {
        id: 'sc-5',
        order: 5,
        title: 'Patch or Remove Software',
        description: 'Apply vendor patches or completely remove the compromised software.',
        actionType: 'manual',
        estimatedMinutes: 45,
        required: true,
      },
      {
        id: 'sc-6',
        order: 6,
        title: 'Review Vendor Security',
        description: 'Assess the vendor security posture and determine future relationship.',
        actionType: 'decision',
        estimatedMinutes: 30,
        required: true,
      },
    ],
  },
  {
    id: 'pb-credential-stuffing',
    name: 'Credential Stuffing Response',
    description: 'Response procedure for credential stuffing attacks against authentication systems',
    incidentType: 'credential_stuffing',
    severity: ['high', 'medium'],
    mitreTechniques: ['T1110.004', 'T1078', 'T1589'],
    estimatedDuration: 90,
    createdAt: new Date('2024-01-01'),
    updatedAt: new Date('2024-01-30'),
    steps: [
      {
        id: 'cs-1',
        order: 1,
        title: 'Detect Attack Pattern',
        description: 'Analyze authentication logs for high-volume failed login attempts from multiple IPs.',
        actionType: 'automated',
        estimatedMinutes: 10,
        required: true,
        automationHook: 'detect_credential_stuffing',
      },
      {
        id: 'cs-2',
        order: 2,
        title: 'Enable CAPTCHA',
        description: 'Activate CAPTCHA challenges for login attempts from suspicious sources.',
        actionType: 'automated',
        estimatedMinutes: 5,
        required: true,
        automationHook: 'enable_captcha',
      },
      {
        id: 'cs-3',
        order: 3,
        title: 'Block Attacking IPs',
        description: 'Add attacking IP addresses and ranges to blocklist.',
        actionType: 'automated',
        estimatedMinutes: 10,
        required: true,
        automationHook: 'block_ip',
      },
      {
        id: 'cs-4',
        order: 4,
        title: 'Identify Compromised Accounts',
        description: 'Check which accounts had successful logins during the attack window.',
        actionType: 'manual',
        estimatedMinutes: 20,
        required: true,
      },
      {
        id: 'cs-5',
        order: 5,
        title: 'Force Password Reset',
        description: 'Force password reset for potentially compromised accounts.',
        actionType: 'manual',
        estimatedMinutes: 15,
        required: true,
      },
      {
        id: 'cs-6',
        order: 6,
        title: 'Enforce MFA',
        description: 'Require multi-factor authentication for affected accounts.',
        actionType: 'manual',
        estimatedMinutes: 20,
        required: true,
      },
    ],
  },
  {
    id: 'pb-sql-injection',
    name: 'SQL Injection Response',
    description: 'Response procedure for detected SQL injection attacks',
    incidentType: 'sql_injection',
    severity: ['critical', 'high', 'medium'],
    mitreTechniques: ['T1190', 'T1059.004'],
    estimatedDuration: 120,
    createdAt: new Date('2024-01-01'),
    updatedAt: new Date('2024-02-01'),
    steps: [
      {
        id: 'sql-1',
        order: 1,
        title: 'Block Attacking IP',
        description: 'Immediately block the source IP of the SQL injection attempt.',
        actionType: 'automated',
        estimatedMinutes: 2,
        required: true,
        automationHook: 'block_ip',
      },
      {
        id: 'sql-2',
        order: 2,
        title: 'Analyze Attack Payload',
        description: 'Review WAF logs to understand the injection payload and targeted endpoint.',
        actionType: 'manual',
        estimatedMinutes: 20,
        required: true,
      },
      {
        id: 'sql-3',
        order: 3,
        title: 'Check for Data Exposure',
        description: 'Verify if any data was successfully exfiltrated through the injection.',
        actionType: 'manual',
        estimatedMinutes: 30,
        required: true,
      },
      {
        id: 'sql-4',
        order: 4,
        title: 'Patch Vulnerable Endpoint',
        description: 'Fix the vulnerable code with parameterized queries or stored procedures.',
        actionType: 'manual',
        estimatedMinutes: 45,
        required: true,
      },
      {
        id: 'sql-5',
        order: 5,
        title: 'Update WAF Rules',
        description: 'Add specific rules to WAF to block similar attack patterns.',
        actionType: 'automated',
        estimatedMinutes: 10,
        required: true,
        automationHook: 'update_waf_rules',
      },
      {
        id: 'sql-6',
        order: 6,
        title: 'Scan for Similar Vulnerabilities',
        description: 'Run security scan on all endpoints for similar SQL injection vulnerabilities.',
        actionType: 'automated',
        estimatedMinutes: 30,
        required: false,
        automationHook: 'vulnerability_scan',
      },
    ],
  },
  {
    id: 'pb-zero-day',
    name: 'Zero-Day Exploit Response',
    description: 'Emergency response procedure for zero-day vulnerability exploitation',
    incidentType: 'zero_day',
    severity: ['critical'],
    mitreTechniques: ['T1190', 'T1203', 'T1211'],
    estimatedDuration: 360,
    createdAt: new Date('2024-01-01'),
    updatedAt: new Date('2024-02-05'),
    steps: [
      {
        id: 'zd-1',
        order: 1,
        title: 'Assess Impact Scope',
        description: 'Determine which systems are running the vulnerable software.',
        actionType: 'automated',
        estimatedMinutes: 20,
        required: true,
        automationHook: 'software_inventory',
      },
      {
        id: 'zd-2',
        order: 2,
        title: 'Implement Temporary Mitigations',
        description: 'Apply vendor-recommended workarounds until a patch is available.',
        actionType: 'manual',
        estimatedMinutes: 45,
        required: true,
      },
      {
        id: 'zd-3',
        order: 3,
        title: 'Increase Monitoring',
        description: 'Deploy additional detection rules for exploitation attempts.',
        actionType: 'automated',
        estimatedMinutes: 15,
        required: true,
        automationHook: 'deploy_detection_rules',
      },
      {
        id: 'zd-4',
        order: 4,
        title: 'Check for Compromise',
        description: 'Hunt for indicators of compromise on potentially affected systems.',
        actionType: 'manual',
        estimatedMinutes: 60,
        required: true,
      },
      {
        id: 'zd-5',
        order: 5,
        title: 'Coordinate with Vendor',
        description: 'Contact vendor for patch timeline and additional guidance.',
        actionType: 'manual',
        estimatedMinutes: 30,
        required: true,
      },
      {
        id: 'zd-6',
        order: 6,
        title: 'Apply Emergency Patch',
        description: 'Deploy vendor patch as soon as it becomes available.',
        actionType: 'manual',
        estimatedMinutes: 90,
        required: true,
      },
      {
        id: 'zd-7',
        order: 7,
        title: 'Verify Remediation',
        description: 'Confirm all systems are patched and no compromise occurred.',
        actionType: 'manual',
        estimatedMinutes: 45,
        required: true,
      },
    ],
  },
];

// Helper function to get playbook by incident type
export const getPlaybookByType = (incidentType: string): Playbook | undefined => {
  return defaultPlaybooks.find(p => p.incidentType === incidentType);
};

// Helper function to get playbooks by severity
export const getPlaybooksBySeverity = (severity: string): Playbook[] => {
  return defaultPlaybooks.filter(p => p.severity.includes(severity));
};

// Calculate progress percentage
export const calculatePlaybookProgress = (execution: PlaybookExecution, playbook: Playbook): number => {
  const completedSteps = Object.values(execution.stepStatuses).filter(
    s => s.status === 'completed' || s.status === 'skipped'
  ).length;
  return Math.round((completedSteps / playbook.steps.length) * 100);
};
